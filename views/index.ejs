<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Image Nudifier</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/style.css">
    <script src="/socket.io/socket.io.js"></script>
    <!-- Advanced CAPTCHA: Fetch SVG from backend -->
    <script>
        // Fetch and display advanced SVG CAPTCHA
        async function fetchCaptcha() {
            const captchaContainer = document.getElementById('captchaContainer');
            const captchaImage = document.getElementById('captchaImage');
            const captchaToken = document.getElementById('captcha_token');
            const captchaAnswer = document.getElementById('captcha_answer');
            captchaAnswer.value = '';
            try {
                const res = await fetch('/captcha');
                if (!res.ok) throw new Error('Failed to fetch CAPTCHA');
                const data = await res.json();
                captchaImage.innerHTML = data.image;
                captchaToken.value = data.token;
            } catch (e) {
                captchaImage.innerHTML = '<span style="color:#ff4d4d">Failed to load CAPTCHA</span>';
                captchaToken.value = '';
            }
        }
        // Fetch captchaDisabled from API and show/hide CAPTCHA accordingly
        let captchaDisabled = false;
        async function checkCaptchaStatusAndInit() {
            const isLocal = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
            try {
                const res = await fetch('/api/captcha-status');
                if (res.ok) {
                    const data = await res.json();
                    captchaDisabled = !!data.captchaDisabled;
                }
            } catch (e) {
                captchaDisabled = false;
            }
            const captchaContainer = document.getElementById('captchaContainer');
            const captchaAnswer = document.getElementById('captcha_answer');
            if (captchaContainer) {
                if (isLocal || captchaDisabled) {
                    captchaContainer.style.display = 'none';
                    if (captchaAnswer) captchaAnswer.removeAttribute('required');
                } else {
                    captchaContainer.style.display = '';
                    if (captchaAnswer) captchaAnswer.setAttribute('required', 'required');
                }
            }
            if (!isLocal && !captchaDisabled) fetchCaptcha();
        }
        window.addEventListener('DOMContentLoaded', checkCaptchaStatusAndInit);
    </script>
</head>

<body>
    <h1>Image Nudifier</h1>

    <form id="uploadForm" enctype="multipart/form-data">
        <p id="queueStatusDisplay">Queue: <span id="queueSize">0</span>, Status: <span
                id="processingStatus">Idle</span><span class="progressPercentage"></span>, Your Position: <span
                id="yourPosition">N/A</span></p>
        <div class="main-container">
            <div class="input-col">
                <div class="upload-section">
                    <h2>Upload Image</h2>
                    <div id="dropArea" class="drop-area image-box">
                        <p id="dropText" class="placeholder">Drag & drop or click to upload</p>
                        <img id="previewImage" />
                        <input id="inputImage" type="file" name="image" accept="image/*" />
                    </div>
                    <button class="upload-btn" type="submit">Upload</button>
                </div>
            </div>
            <div class="settings-col">
                <div class="settings-section">
                    <label for="prompt" class="settings-label">Prompt:</label>
                    <input type="text" id="prompt" name="prompt" class="settings-input" value="Change clothes to nothing revealing realistic and detailed skin, breasts and nipples. 
Preserve the person in the exact same position, scale, and pose. 
Preserve the exact same face details, shape and expression. " />
                    <div class="settings-row">
                        <div class="settings-item">
                            <label for="steps" class="settings-label">Steps:</label>
                            <input type="number" id="steps" name="steps" class="settings-input" value="20" min="1"
                                max="100" />
                        </div>
                        <div class="settings-item">
                            <label for="outputHeight" class="settings-label">Output Height:</label>
                            <input type="number" id="outputHeight" name="outputHeight" class="settings-input"
                                value="1080" min="64" max="4096" />
                        </div>
                    </div>
                    <fieldset class="lora-fieldset">
                        <legend>LoRA Settings</legend>
                        <div class="lora-grid">
                            <div class="lora-row">
                                <div class="lora-main">
                                    <input type="checkbox" id="lora_1_on" name="lora_1_on" checked>
                                    <label for="lora_1_on">change_clothes_to_nothing_000011200</label>
                                </div>
                                <div class="lora-strength-group">
                                    <input type="number" id="lora_1_strength" name="lora_1_strength" value="1" min="0"
                                        max="2" step="0.01" class="lora-strength" />
                                    <label for="lora_1_strength">Strength</label>
                                </div>
                            </div>
                            <div class="lora-row">
                                <div class="lora-main">
                                    <input type="checkbox" id="lora_2_on" name="lora_2_on">
                                    <label for="lora_2_on">real_textures-000011</label>
                                </div>
                                <div class="lora-strength-group">
                                    <input type="number" id="lora_2_strength" name="lora_2_strength" value="0.7" min="0"
                                        max="2" step="0.01" class="lora-strength" />
                                    <label for="lora_2_strength">Strength</label>
                                </div>
                            </div>
                            <div class="lora-row">
                                <div class="lora-main">
                                    <input type="checkbox" id="lora_3_on" name="lora_3_on">
                                    <label for="lora_3_on">Flux_Ultimator</label>
                                </div>
                                <div class="lora-strength-group">
                                    <input type="number" id="lora_3_strength" name="lora_3_strength" value="0.5" min="0"
                                        max="2" step="0.01" class="lora-strength" />
                                    <label for="lora_3_strength">Strength</label>
                                </div>
                            </div>
                            <div class="lora-row">
                                <div class="lora-main">
                                    <input type="checkbox" id="lora_4_on" name="lora_4_on">
                                    <label for="lora_4_on">FLUX_FD-Nipple-Detail-R4</label>
                                </div>
                                <div class="lora-strength-group">
                                    <input type="number" id="lora_4_strength" name="lora_4_strength" value="0.8" min="0"
                                        max="2" step="0.01" class="lora-strength" />
                                    <label for="lora_4_strength">Strength</label>
                                </div>
                            </div>
                            <div class="lora-row">
                                <div class="lora-main">
                                    <input type="checkbox" id="lora_5_on" name="lora_5_on" checked>
                                    <label for="lora_5_on">aidmaRealisticSkin-FLUX-v0.1</label>
                                </div>
                                <div class="lora-strength-group">
                                    <input type="number" id="lora_5_strength" name="lora_5_strength" value="0.6" min="0"
                                        max="2" step="0.01" class="lora-strength" />
                                    <label for="lora_5_strength">Strength</label>
                                </div>
                            </div>
                        </div>
                    </fieldset>
                    <div class="captcha-container" id="captchaContainer">
                            <div class="captcha-row">
                                <span id="captchaImage"></span>
                                <button type="button" class="refresh-captcha-btn" onclick="fetchCaptcha()"
                                    title="Refresh CAPTCHA">&#x21bb;</button>
                            </div>
                            <input type="text" id="captcha_answer" name="captcha_answer" placeholder="Enter CAPTCHA"
                                required autocomplete="off" class="captcha-input" />
                            <input type="hidden" id="captcha_token" name="captcha_token" />
                            <div id="captchaError" class="captcha-error"></div>
                    </div>
                </div>
            </div>
            <div class="output-col">
                <div class="output-section">
                    <h2>Processed Output</h2>
                    <div id="outputArea" class="image-box">
                        <p id="outputPlaceholder" class="placeholder">Your processed image will appear here.</p>
                        <img id="outputImage" src="" alt="Processed Image" style="display:none;" />
                    </div>
                    <a id="downloadLink" href="#" download style="display:none;">
                        <button class="download-btn" type="button">Download</button>
                    </a>
                </div>
            </div>
        </div>
    </form>

    <script src="/js/main.js"></script>
</body>

</html>